---
import BaseLayout from '../layouts/BaseLayout.astro';
import skillsData from '../data/skills.json';
import { readdirSync } from 'fs';
import { join } from 'path';
import exifr from 'exifr';
import sharp from 'sharp';
import heicConvert from 'heic-convert';
import { readFileSync, writeFileSync, existsSync } from 'fs';

const categories = Object.entries(skillsData) as [string, string[]][];

// Bio entry photos — order must match data-index attributes in the HTML below
const bioPhotos = [
  { src: '/images/about/JPL_Summit.jpg',     caption: 'Summit of Mt. Whitney with JPL colleagues' },
  { src: '/images/about/JPL_Mars_Rover.jpg', caption: 'Mars Rover VSTB, NASA JPL'                 },
  { src: '/images/about/Racecar.jpg',        caption: 'Endurance racing — Spec Miata'              },
  { src: '/images/about/Free_Solo.jpg',      caption: 'Free solo, Joshua Tree'                     },
  { src: '/images/about/Family.jpg',         caption: 'Austin, TX'                                 },
];

// Strip photos — auto-discovered from public/images/about/strip/
// Drop any photo into that folder and it will appear in the strip automatically.
// Captions are read from the IPTC Caption-Abstract field embedded in each file
// (write with: exiftool -overwrite_original -IPTC:Caption-Abstract="…" photo.jpg).
// Falls back to the filename if no caption is embedded.
const IMAGE_EXTS = new Set(['.jpg', '.jpeg', '.png', '.webp', '.avif']);
const HEIF_EXTS  = new Set(['.heic', '.heif']);
const STRIP_H = 220; // display height in px — width is scaled to preserve aspect ratio
let stripPhotos: { src: string; caption: string; w: number; h: number }[] = [];
try {
  const dir = join(process.cwd(), 'public/images/about/strip');
  const files = readdirSync(dir)
    .filter(f => {
      const ext = f.slice(f.lastIndexOf('.')).toLowerCase();
      return IMAGE_EXTS.has(ext) || HEIF_EXTS.has(ext);
    })
    .sort();
  stripPhotos = await Promise.all(
    files.map(async f => {
      const ext = f.slice(f.lastIndexOf('.')).toLowerCase();
      const filePath = join(dir, f);
      const fallback = f.replace(/\.[^.]+$/, '').replace(/[-_]/g, ' ');

      // Convert HEIC/HEIF → JPEG next to the original so the browser can load it
      let servePath = filePath;
      let serveFile = f;
      if (HEIF_EXTS.has(ext)) {
        const jpegName = f.replace(/\.[^.]+$/, '.jpg');
        const jpegPath = join(dir, jpegName);
        if (!existsSync(jpegPath)) {
          const jpegBuf = await heicConvert({
            buffer: readFileSync(filePath),
            format: 'JPEG',
            quality: 0.92,
          });
          writeFileSync(jpegPath, Buffer.from(jpegBuf));
        }
        servePath = jpegPath;
        serveFile = jpegName;
      }

      // Read caption from embedded IPTC metadata, fall back to filename
      let caption = fallback;
      try {
        const meta = await exifr.parse(servePath, { iptc: true, pick: ['Caption-Abstract', 'ImageDescription'] });
        caption = meta?.['Caption-Abstract'] || meta?.ImageDescription || fallback;
      } catch { /* no IPTC data */ }

      // Read pixel dimensions so the browser can lay out before images load.
      // Orientations 5-8 involve a 90° rotation, so width and height must be swapped.
      let w = Math.round(STRIP_H * (4 / 3));
      let h = STRIP_H;
      try {
        const { width, height, orientation } = await sharp(servePath).metadata();
        if (width && height) {
          const rotated = orientation != null && orientation >= 5;
          const displayW = rotated ? height : width;
          const displayH = rotated ? width  : height;
          w = Math.round((displayW / displayH) * STRIP_H);
          h = STRIP_H;
        }
      } catch { /* sharp failed */ }

      return { src: `/images/about/strip/${encodeURIComponent(serveFile)}`, caption, w, h };
    })
  );
} catch { /* strip directory missing or empty */ }

const allPhotos = [...bioPhotos, ...stripPhotos];
---

<BaseLayout
  title="About"
  description="Engineer, builder, and filmmaker. Learn about Anish Zute's background, work, and skills."
>
  <!-- Page header + hero photo -->
  <div class="page-header">
    <div class="hero-photo-wrap">
      <img
        src="/images/about/Profile_Landscape.jpg"
        alt="Anish Zute"
        loading="eager"
        decoding="async"
      />
      <div class="hero-text-wrap">
        <div class="container">
          <p class="eyebrow">About me</p>
          <h1>Technology.<br />Science.<br />Adventure.</h1>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo strip -->
  {stripPhotos.length > 0 && (
    <div class="photo-strip-wrap">
      <div class="photo-strip">
        {stripPhotos.map((photo, i) => (
          <button
            class="strip-item photo-btn"
            data-index={bioPhotos.length + i}
            aria-label={`Expand: ${photo.caption}`}
            type="button"
            style={`width:${photo.w}px`}
          >
            <img src={photo.src} alt={photo.caption} width={photo.w} height={photo.h} loading="lazy" decoding="async" />
          </button>
        ))}
      </div>
    </div>
  )}

  <!-- Bio entries -->
  <section class="bio-entries-section">
    <div class="container">

      <!-- ENTRY 1: Career background -->
      <div class="bio-entry">
        <div class="bio-entry-body">
          <p>
            Hi, I'm Anish. I began my career in filmmaking and gradually transitioned into the
            technical foundations behind image-making — moving from production into visual effects,
            engineering simulation and visualization, and ultimately computer vision and machine
            learning. That evolution has taken me through film sets, experimental physics labs, neuroscience
            research, 0–1 startups, and one of the largest venture capital firms in the country.
          </p>
        </div>
        <figure class="bio-entry-figure">
          <button class="photo-btn" data-index="0" aria-label="Expand photo" type="button">
            <div class="photo-frame">
              <img
                src="/images/about/JPL_Summit.jpg"
                alt="Anish and JPL colleagues on the summit of Mt. Whitney"
                loading="lazy"
                decoding="async"
                style="object-position: 50% 75%"
              />
            </div>
          </button>
          <figcaption>Summit of Mt. Whitney with JPL colleagues</figcaption>
        </figure>
      </div>

      <!-- ENTRY 2: Projects / founder (reversed) -->
      <div class="bio-entry bio-entry--reversed">
        <div class="bio-entry-body">
          <p>
            I've contributed to projects spanning Mars rover operations at NASA JPL, an
            award-winning Hyperloop pod, and the development of an autonomous microscope platform
            integrating optics, hardware control, and real-time analysis. I've worked both as a
            founder and as an early-stage investor, building companies firsthand and later
            partnering with technical teams as they scaled. I'm particularly drawn to technically
            ambitious efforts in aerospace, robotics, dual-use, and applied AI.
          </p>
        </div>
        <figure class="bio-entry-figure">
          <button class="photo-btn" data-index="1" aria-label="Expand photo" type="button">
            <div class="photo-frame">
              <img
                src="/images/about/JPL_Mars_Rover.jpg"
                alt="Anish at the Mars Rover Vehicle Systems Testbed at NASA JPL"
                loading="lazy"
                decoding="async"
                style="object-position: 25% 50%"
              />
            </div>
          </button>
          <figcaption>Mars Rover Vehicle Systems Testbed, NASA JPL</figcaption>
        </figure>
      </div>

      <!-- ENTRY 3: Building / cars / F1 -->
      <div class="bio-entry">
        <div class="bio-entry-body">
          <p>
            Outside of work, I'm usually building something, learning a new skill, or pushing
            myself into a new environment. I've spent time in both machine shops and woodshops,
            and I still design parts in CAD and 3D print them at home whenever an idea needs to
            become tangible. I work on and race cars, and volunteer as a Race Marshal for Formula 1,
            which keeps me close to the edge of the sport from another angle.
          </p>
        </div>
        <figure class="bio-entry-figure">
          <button class="photo-btn" data-index="2" aria-label="Expand photo" type="button">
            <div class="photo-frame">
              <img
                src="/images/about/Racecar.jpg"
                alt="Getting ready for an Endurance race in a Spec Miata."
                loading="lazy"
                decoding="async"
              />
            </div>
          </button>
          <figcaption>Getting ready for an Endurance race in a Spec Miata</figcaption>
        </figure>
      </div>

      <!-- ENTRY 4: Climbing / outdoors (reversed) -->
      <div class="bio-entry bio-entry--reversed">
        <div class="bio-entry-body">
          <p>
            I climb regularly and hold both USAC judging credentials and an NCRC Cave Rescue
            certification. I've sailed competitively for most of my life and captained the University of Texas
            Sailing Team in college, and I'm currently training as a student pilot. Continuing
            the theme of learning and exploration, I enjoy traveling, backpacking, and hiking —
            and documenting my adventures on camera.
          </p>
        </div>
        <figure class="bio-entry-figure">
          <button class="photo-btn" data-index="3" aria-label="Expand photo" type="button">
            <div class="photo-frame">
              <img
                src="/images/about/Free_Solo.jpg"
                alt="Anish free soloing in Joshua Tree"
                loading="lazy"
                decoding="async"
                style="object-position: 50% 85%"
              />
            </div>
          </button>
          <figcaption>Free solo of the Cyclops, Joshua Tree, CA</figcaption>
        </figure>
      </div>

      <!-- Closing -->
      <div class="bio-closing">
        <figure class="closing-figure">
          <button class="photo-btn" data-index="4" aria-label="Expand photo" type="button">
            <div class="photo-frame photo-frame--closing">
              <img
                src="/images/about/Family.jpg"
                alt="Anish with his girlfriend and their German Shepherd"
                loading="lazy"
                decoding="async"
                style="object-position: 50% 50%"
              />
            </div>
          </button>
        </figure>
        <p>I currently live in Austin, TX with my wonderful girlfriend and our energetic german shepherd mix.</p>
        <div class="bio-ctas">
          <a href="/projects" class="btn btn-primary">See Projects</a>
          <a href="https://github.com/anishzute" target="_blank" rel="noopener noreferrer" class="btn btn-ghost">GitHub →</a>
        </div>
      </div>

    </div>
  </section>

  <!-- Skills -->
  <section class="skills-section">
    <div class="container">
      <h2>Skills</h2>
      <div class="skills-grid">
        {categories.map(([category, skills]) => (
          <div class="skill-card">
            <h3 class="skill-category">{category}</h3>
            <ul>
              {skills.map(skill => <li set:html={skill.replace(/\n/g, '<br>')} />)}
            </ul>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Lightbox -->
  <dialog class="lightbox" id="lightbox" aria-label="Photo viewer" aria-modal="true">
    <div class="lb-backdrop" id="lb-backdrop"></div>
    <div class="lb-inner">
      <button class="lb-btn lb-close" id="lb-close" aria-label="Close">✕</button>
      <button class="lb-btn lb-prev"  id="lb-prev"  aria-label="Previous">&#8249;</button>
      <button class="lb-btn lb-next"  id="lb-next"  aria-label="Next">&#8250;</button>
      <div class="lb-img-wrap">
        <img id="lb-img" src="" alt="" />
      </div>
      <div class="lb-bar">
        <span class="lb-caption" id="lb-caption"></span>
        <span class="lb-counter" id="lb-counter"></span>
      </div>
    </div>
  </dialog>
</BaseLayout>

<script is:inline define:vars={{ photoData: allPhotos }}>
  var photos  = photoData;
  var current = 0;

  var dialog  = document.getElementById('lightbox');
  var lbImg   = document.getElementById('lb-img');
  var caption = document.getElementById('lb-caption');
  var counter = document.getElementById('lb-counter');

  function show(index) {
    current = ((index % photos.length) + photos.length) % photos.length;
    var p = photos[current];
    lbImg.src = p.src;
    lbImg.alt = p.caption;
    caption.textContent = p.caption;
    counter.textContent = (current + 1) + ' / ' + photos.length;
  }

  function openAt(index) {
    show(index);
    dialog.showModal();
  }

  document.querySelectorAll('.photo-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      openAt(Number(btn.dataset.index));
    });
  });

  document.getElementById('lb-close').addEventListener('click',    function() { dialog.close(); });
  document.getElementById('lb-prev').addEventListener('click',     function() { show(current - 1); });
  document.getElementById('lb-next').addEventListener('click',     function() { show(current + 1); });
  document.getElementById('lb-backdrop').addEventListener('click', function() { dialog.close(); });

  document.addEventListener('keydown', function(e) {
    if (!dialog.open) return;
    if (e.key === 'ArrowLeft')  { e.preventDefault(); show(current - 1); }
    if (e.key === 'ArrowRight') { e.preventDefault(); show(current + 1); }
    if (e.key === 'Escape')     { dialog.close(); }
  });

  var touchStartX = 0;
  dialog.addEventListener('touchstart', function(e) { touchStartX = e.touches[0].clientX; }, { passive: true });
  dialog.addEventListener('touchend',   function(e) {
    var dx = e.changedTouches[0].clientX - touchStartX;
    if (Math.abs(dx) > 50) show(dx < 0 ? current + 1 : current - 1);
  });

  // ── Photo strip: shuffle on each page load ───────────────
  var strip = document.querySelector('.photo-strip');
  if (strip) {
    var items = Array.from(strip.querySelectorAll('.strip-item'));
    for (var i = items.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = items[i]; items[i] = items[j]; items[j] = tmp;
    }
    items.forEach(function(el) { strip.appendChild(el); });
  }

  // ── Photo strip: scroll wheel + click-drag ────────────────
  if (strip) {
    // Scroll wheel → horizontal scroll
    strip.addEventListener('wheel', function(e) {
      if (e.deltaY === 0) return;
      e.preventDefault();
      strip.scrollLeft += e.deltaY;
    }, { passive: false });

    // Click-drag to scroll
    var isDragging = false, dragStartX = 0, scrollStartLeft = 0;
    strip.addEventListener('mousedown', function(e) {
      isDragging = true;
      dragStartX = e.pageX;
      scrollStartLeft = strip.scrollLeft;
    });
    window.addEventListener('mousemove', function(e) {
      if (!isDragging) return;
      e.preventDefault();
      strip.scrollLeft = scrollStartLeft - (e.pageX - dragStartX);
    });
    window.addEventListener('mouseup', function() { isDragging = false; });
  }
</script>

<style>
  /* ── Page header ─────────────────────────────────────────── */
  .page-header {
    padding-top: var(--nav-h);
  }

  /* Full-width cinematic banner */
  .hero-photo-wrap {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    background: var(--bg-elevated);
  }

  .hero-photo-wrap img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center 25%;
    display: block;
  }

  /* Gradient so text stays legible over the image */
  .hero-photo-wrap::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to top,
      rgba(6, 6, 6, 0.75) 0%,
      rgba(6, 6, 6, 0.25) 25%,
      transparent 85%
    );
    pointer-events: none;
  }

  /* Text overlay, sits above the gradient */
  .hero-text-wrap {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1;
    padding-bottom: 2.5rem;
  }

  .eyebrow {
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: rgba(255, 255, 255, 0.55);
    margin-bottom: 1rem;
  }

  .page-header h1 {
    font-size: clamp(2.4rem, 5.5vw, 4rem);
    line-height: 1.08;
    margin: 0;
    color: #f0ede8;
  }

  /* ── Photo strip ────────────────────────────────────────── */
  .photo-strip-wrap {
    border-bottom: 1px solid var(--border);
    background: var(--bg-raised);
  }

  .photo-strip {
    display: flex;
    flex-wrap: nowrap;
    gap: 4px;
    overflow-x: auto;
    padding: 0.75rem 0;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    cursor: grab;
  }

  .photo-strip:active {
    cursor: grabbing;
  }

  .photo-strip::-webkit-scrollbar {
    display: none;
  }

  .strip-item {
    /* width is set via inline style (sharp-computed at build time) */
    flex-shrink: 0;
    height: 220px;
    padding: 0;
    border: none;
    background: none;
    cursor: zoom-in;
    border-radius: 4px;
    overflow: hidden;
    line-height: 0;
  }

  .strip-item img {
    width: 100%;
    height: 100%;
    display: block;
    transition: opacity 0.2s, transform 0.3s ease;
  }

  .strip-item:hover img {
    opacity: 0.82;
    transform: scale(1.03);
  }

  /* ── Bio entries ─────────────────────────────────────────── */
  .bio-entries-section {
    padding-bottom: var(--section-gap);
    border-bottom: 1px solid var(--border);
  }

  .bio-entry {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    padding: 3.5rem 0;
    border-top: 1px solid var(--border);
    align-items: center;
  }

  @media (min-width: 760px) {
    .bio-entry {
      grid-template-columns: 1fr 1fr;
      gap: 5rem;
    }

    .bio-entry--reversed .bio-entry-figure {
      order: -1;
    }
  }

  .bio-entry-body p {
    font-size: 1.02rem;
    line-height: 1.8;
    color: var(--text-2);
    max-width: 52ch;
  }

  .bio-entry-figure {
    margin: 0;
  }

  /* ── Photo frame ─────────────────────────────────────────── */
  .photo-frame {
    border-radius: 7px;
    overflow: hidden;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    aspect-ratio: 4 / 3;
  }

  .photo-frame--closing {
    aspect-ratio: 4 / 3;
  }

  .photo-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.35s ease, opacity 0.2s;
  }

  /* Clickable photo button */
  .photo-btn {
    display: block;
    width: 100%;
    padding: 0;
    border: none;
    background: none;
    cursor: zoom-in;
    border-radius: 7px;
    overflow: hidden;
  }

  .photo-btn:hover .photo-frame img {
    transform: scale(1.03);
    opacity: 0.88;
  }

  figcaption {
    margin-top: 0.55rem;
    font-size: 0.75rem;
    color: var(--text-3);
    text-align: center;
    font-style: italic;
    letter-spacing: 0.02em;
  }

  /* ── Closing ─────────────────────────────────────────────── */
  .bio-closing {
    padding: 3.5rem 0 1rem;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .closing-figure {
    margin: 0 0 2.25rem;
    width: 100%;
    max-width: 480px;
  }

  .bio-closing > p {
    font-size: 1.02rem;
    color: var(--text-2);
    margin-bottom: 1.75rem;
    max-width: 44ch;
  }

  .bio-ctas {
    display: flex;
    gap: 0.85rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  /* ── Skills ──────────────────────────────────────────────── */
  .skills-section {
    padding: var(--section-gap) 0;
  }

  .skills-section h2 {
    margin-bottom: 2rem;
  }

  .skills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }

  .skill-card {
    background: var(--bg-raised);
    padding: 1.5rem 1.35rem;
    transition: background 0.2s;
  }

  .skill-card:hover {
    background: var(--bg-elevated);
  }

  .skill-category {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent);
    margin-bottom: 1rem;
  }

  .skill-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .skill-card li {
    font-size: 0.875rem;
    color: var(--text-2);
    padding: 0.4rem 0;
    border-bottom: 1px solid var(--border);
    line-height: 1.4;
  }

  .skill-card li:last-child {
    border-bottom: none;
  }

  /* ── Lightbox ────────────────────────────────────────────── */
  dialog.lightbox {
    position: fixed;
    inset: 0;
    margin: 0;
    padding: 0;
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    border: none;
    background: rgba(6, 6, 6, 0.97);
    display: none;
    outline: none;
  }

  dialog.lightbox[open] {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  dialog.lightbox::backdrop { display: none; }

  .lb-backdrop {
    position: absolute;
    inset: 0;
    z-index: 0;
    cursor: zoom-out;
  }

  .lb-inner {
    position: relative;
    z-index: 1;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3.5rem 5rem 2rem;
    gap: 0.75rem;
    pointer-events: none;
  }

  @media (max-width: 600px) {
    .lb-inner { padding: 3rem 1rem 1.5rem; gap: 0.5rem; }
  }

  .lb-btn {
    position: absolute;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    color: rgba(240,237,232,0.7);
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.15s, color 0.15s;
    line-height: 1;
    pointer-events: auto;
  }

  .lb-btn:hover {
    background: rgba(255,255,255,0.12);
    color: #f0ede8;
  }

  .lb-close {
    top: 1rem;
    right: 1rem;
    font-size: 1rem;
    padding: 0.5rem 0.65rem;
  }

  .lb-prev, .lb-next {
    top: 50%;
    transform: translateY(-50%);
    font-size: 2rem;
    padding: 0.6rem 0.85rem;
  }

  .lb-prev { left: 0.75rem; }
  .lb-next { right: 0.75rem; }

  @media (max-width: 480px) {
    .lb-prev { left: 0.25rem; }
    .lb-next { right: 0.25rem; }
    .lb-prev, .lb-next { font-size: 1.5rem; padding: 0.5rem 0.65rem; }
  }

  .lb-img-wrap {
    flex: 0 1 auto;
    min-height: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
  }

  #lb-img {
    max-width: 100%;
    max-height: calc(100dvh - 11rem);
    object-fit: contain;
    border-radius: 3px;
    display: block;
    user-select: none;
    -webkit-user-drag: none;
    pointer-events: auto;
  }

  .lb-bar {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.35rem;
    pointer-events: auto;
  }

  .lb-caption {
    font-size: 0.82rem;
    color: rgba(240,237,232,0.65);
    font-style: italic;
    letter-spacing: 0.02em;
  }

  .lb-counter {
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(240,237,232,0.3);
  }
</style>
