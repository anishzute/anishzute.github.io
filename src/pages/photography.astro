---
import BaseLayout from '../layouts/BaseLayout.astro';
import { readdirSync } from 'fs';
import { join } from 'path';

/**
 * LIGHTROOM SETUP
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Set your Lightroom shared album URL one of two ways:
 *
 * Option A â€” environment variable (recommended for GitHub Actions):
 *   Add LIGHTROOM_SHARE_URL to your repo secrets / .env file.
 *   GitHub Actions: Settings â†’ Secrets â†’ Actions â†’ New secret
 *
 * Option B â€” hard-code it directly here:
 *   const LIGHTROOM_SHARE_URL = 'https://lightroom.adobe.com/shares/YOUR_SHARE_ID';
 */
const LIGHTROOM_SHARE_URL: string =
  import.meta.env.LIGHTROOM_SHARE_URL || '';

type Photo = { src: string; alt: string; width?: number; height?: number };

let photos: Photo[] = [];
let useFallbackIframe = false;
let fetchAttempted = false;

if (LIGHTROOM_SHARE_URL) {
  fetchAttempted = true;
  try {
    // Astro frontmatter runs at build time (server-side) â€” no CORS restrictions.
    const shareId = LIGHTROOM_SHARE_URL.split('/shares/').pop()?.split('?')[0] ?? '';

    // Step 1: resolve share â†’ get spaceId
    const shareRes = await fetch(
      `https://lightroom.adobe.com/v2/shares/${shareId}`,
      { headers: { Accept: 'application/json' } }
    );

    if (shareRes.ok) {
      const shareData = await shareRes.json();
      const spaceId: string = shareData?.space?.id ?? '';

      if (spaceId) {
        // Step 2: list assets
        const assetsRes = await fetch(
          `https://lightroom.adobe.com/v2/spaces/${spaceId}/assets` +
            `?subtype=image&order_by=captureDate&order_direction=desc&limit=100`,
          { headers: { Accept: 'application/json' } }
        );

        if (assetsRes.ok) {
          const assetsData = await assetsRes.json();
          photos = (assetsData?.resources ?? []).map((asset: Record<string, unknown>) => ({
            src: `https://lightroom.adobe.com/v2/spaces/${spaceId}/assets/${asset['id']}/renditions/2048`,
            alt: (asset['payload'] as Record<string, unknown>)?.['xmp'] as string ?? 'Photo',
          }));
        }
      }
    }

    // If we couldn't get photos via the API, fall back to the iframe
    if (photos.length === 0) useFallbackIframe = true;
  } catch {
    useFallbackIframe = true;
  }
}

// Auto-discover all images in public/images/photography/
const IMAGE_EXTS = new Set(['.jpg', '.jpeg', '.png', '.webp', '.avif']);
let localPhotos: Photo[] = [];
try {
  const dir = join(process.cwd(), 'public/images/photography');
  localPhotos = readdirSync(dir)
    .filter(f => IMAGE_EXTS.has(f.slice(f.lastIndexOf('.')).toLowerCase()))
    .map(f => ({ src: `/images/photography/${encodeURIComponent(f)}`, alt: '' }));
} catch { /* directory empty or missing */ }

const allPhotos = [...photos, ...localPhotos];
---

<BaseLayout
  title="Photography"
  description="A gallery of photos from track days, road trips, and the fabrication shop â€” by Anish Zute."
>
  <div class="page-top">
    <div class="container">
      <div class="page-header">
        <h1>Photography</h1>
        <p>Track days, road trips, and whatever catches the eye.</p>
        {LIGHTROOM_SHARE_URL && (
          <a
            href={LIGHTROOM_SHARE_URL}
            target="_blank"
            rel="noopener noreferrer"
            class="lightroom-link"
          >
            View full album on Lightroom â†—
          </a>
        )}
      </div>
    </div>
  </div>

  <!-- {/* Lightroom link card â€” shown when API didn't return photos but a URL is set */}
  {useFallbackIframe && LIGHTROOM_SHARE_URL && (
    <div class="lr-cta-wrapper container">
      <a
        href={LIGHTROOM_SHARE_URL}
        target="_blank"
        rel="noopener noreferrer"
        class="lr-cta-card"
      >
        <span class="lr-cta-icon">ðŸ“·</span>
        <div>
          <p class="lr-cta-label">View the full gallery</p>
          <p class="lr-cta-sub">Opens on Lightroom â†—</p>
        </div>
      </a>
    </div>
  )} -->

  {/* Masonry grid â€” Lightroom API photos + manual photos */}
  {allPhotos.length > 0 && (
    <div class="gallery-wrapper container">
      <div class="masonry">
        {allPhotos.map(photo => (
          <div class="masonry-item">
            <img
              src={photo.src}
              alt={photo.alt}
              loading="lazy"
              decoding="async"
              width={photo.width}
              height={photo.height}
            />
          </div>
        ))}
      </div>
    </div>
  )}

  {/* Empty state â€” no URL configured yet */}
  {!LIGHTROOM_SHARE_URL && allPhotos.length === 0 && (
    <div class="empty-state container">
      <p class="empty-icon">ðŸ“·</p>
      <h2>Gallery coming soon</h2>
      <p>
        To show your Lightroom album here, set the
        <code>LIGHTROOM_SHARE_URL</code> environment variable to your
        Lightroom shared album URL (e.g.{' '}
        <code>https://lightroom.adobe.com/shares/abc123</code>).
      </p>
      <p>
        You can also add individual photos by placing them in{' '}
        <code>public/images/photography/</code> and listing them in the{' '}
        <code>manualPhotos</code> array at the top of this file.
      </p>
    </div>
  )}
</BaseLayout>

<style>
  .page-top {
    padding-top: calc(var(--nav-h) + 3rem);
    padding-bottom: 2rem;
  }

  .page-header {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .page-header h1 {
    margin-bottom: 0.25rem;
  }

  .page-header p {
    font-size: 1.05rem;
    color: var(--text-2);
  }

  .lightroom-link {
    margin-top: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--accent);
    text-decoration: none;
    align-self: flex-start;
    transition: color 0.15s;
  }

  .lightroom-link:hover {
    color: var(--accent-hover);
  }

  /* Lightroom link card fallback */
  .lr-cta-wrapper {
    padding-top: 1rem;
    padding-bottom: 3rem;
  }

  .lr-cta-card {
    display: inline-flex;
    align-items: center;
    gap: 1.25rem;
    padding: 1.5rem 2rem;
    background: var(--bg-raised);
    border: 1px solid var(--border-strong);
    border-radius: 10px;
    text-decoration: none;
    color: inherit;
    transition: border-color 0.2s, background 0.2s, transform 0.2s;
  }

  .lr-cta-card:hover {
    border-color: var(--accent);
    background: var(--bg-elevated);
    transform: translateY(-2px);
    text-decoration: none;
  }

  .lr-cta-icon {
    font-size: 2rem;
    line-height: 1;
    flex-shrink: 0;
  }

  .lr-cta-label {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.2rem;
    max-width: none;
  }

  .lr-cta-sub {
    font-size: 0.82rem;
    color: var(--accent);
    max-width: none;
  }

  /* Masonry grid */
  .gallery-wrapper {
    padding-top: 2rem;
    padding-bottom: var(--section-gap);
  }

  .masonry {
    columns: 2;
    column-gap: 8px;
  }

  @media (min-width: 640px) {
    .masonry { columns: 3; }
  }

  @media (min-width: 960px) {
    .masonry { columns: 4; }
  }

  .masonry-item {
    break-inside: avoid;
    margin-bottom: 8px;
  }

  .masonry-item img {
    width: 100%;
    height: auto;
    border-radius: 4px;
    display: block;
    background: var(--bg-elevated);
    transition: opacity 0.2s;
  }

  .masonry-item img:hover {
    opacity: 0.9;
  }

  /* Empty state */
  .empty-state {
    padding: var(--section-gap) var(--gutter);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 560px;
  }

  .empty-icon {
    font-size: 2.5rem;
    max-width: none;
  }

  .empty-state h2 {
    font-size: 1.5rem;
  }

  .empty-state p {
    font-size: 0.925rem;
    color: var(--text-2);
    line-height: 1.7;
  }
</style>
