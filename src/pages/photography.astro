---
import BaseLayout from '../layouts/BaseLayout.astro';
import { readdirSync } from 'fs';
import { join } from 'path';
import exifr from 'exifr';

/**
 * LIGHTROOM SETUP
 * Set LIGHTROOM_SHARE_URL as a GitHub Actions secret (Option A)
 * or hard-code it below (Option B).
 */
const LIGHTROOM_SHARE_URL: string = import.meta.env.LIGHTROOM_SHARE_URL || '';

type ExifMeta = {
  Make?: string; Model?: string; LensModel?: string;
  FocalLength?: number; FNumber?: number; ExposureTime?: number;
  ISO?: number; DateTimeOriginal?: string | Date;
};

type Photo = { src: string; meta: ExifMeta };

// â”€â”€ Lightroom API fetch (build-time, no CORS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lrPhotos: Photo[] = [];

if (LIGHTROOM_SHARE_URL) {
  try {
    const shareId = LIGHTROOM_SHARE_URL.split('/shares/').pop()?.split('?')[0] ?? '';
    const shareRes = await fetch(`https://lightroom.adobe.com/v2/shares/${shareId}`, {
      headers: { Accept: 'application/json' },
    });
    if (shareRes.ok) {
      const shareData = await shareRes.json();
      const spaceId: string = shareData?.space?.id ?? '';
      if (spaceId) {
        const assetsRes = await fetch(
          `https://lightroom.adobe.com/v2/spaces/${spaceId}/assets?subtype=image&order_by=captureDate&order_direction=desc&limit=100`,
          { headers: { Accept: 'application/json' } }
        );
        if (assetsRes.ok) {
          const assetsData = await assetsRes.json();
          lrPhotos = (assetsData?.resources ?? []).map((asset: Record<string, unknown>) => ({
            src: `https://lightroom.adobe.com/v2/spaces/${spaceId}/assets/${asset['id']}/renditions/2048`,
            meta: {},
          }));
        }
      }
    }
  } catch { /* Lightroom API unavailable â€” local photos still shown */ }
}

// â”€â”€ Auto-discover local images + read EXIF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const IMAGE_EXTS = new Set(['.jpg', '.jpeg', '.png', '.webp', '.avif']);
const EXIF_TAGS = ['Make', 'Model', 'LensModel', 'FocalLength', 'FNumber', 'ExposureTime', 'ISO', 'DateTimeOriginal'] as const;

let localPhotos: Photo[] = [];
try {
  const dir = join(process.cwd(), 'public/images/photography');
  const files = readdirSync(dir).filter(f =>
    IMAGE_EXTS.has(f.slice(f.lastIndexOf('.')).toLowerCase())
  );
  localPhotos = await Promise.all(
    files.map(async f => {
      const filePath = join(process.cwd(), 'public/images/photography', f);
      let meta: ExifMeta = {};
      try {
        meta = (await exifr.parse(filePath, { pick: [...EXIF_TAGS] })) ?? {};
        // exifr returns Date objects â€” convert to ISO string for JSON serialisation
        if (meta.DateTimeOriginal instanceof Date) {
          meta.DateTimeOriginal = (meta.DateTimeOriginal as Date).toISOString();
        }
      } catch { /* no EXIF or unsupported format */ }
      return { src: `/images/photography/${encodeURIComponent(f)}`, meta };
    })
  );
} catch { /* directory missing */ }

const allPhotos: Photo[] = [...lrPhotos, ...localPhotos];
---

<BaseLayout
  title="Photography"
  description="A gallery of photos from track days, road trips, and the fabrication shop â€” by Anish Zute."
>
  <!-- Page header -->
  <div class="page-top">
    <div class="container">
      <h1>Photography</h1>
      <p>Track days, road trips, and whatever catches the eye.</p>
      {LIGHTROOM_SHARE_URL && (
        <a href={LIGHTROOM_SHARE_URL} target="_blank" rel="noopener noreferrer" class="lr-link">
          View full album on Lightroom â†—
        </a>
      )}
    </div>
  </div>

  <!-- Masonry gallery -->
  {allPhotos.length > 0 && (
    <div class="gallery-wrap container">
      <div class="masonry" id="masonry">
        {allPhotos.map((photo, i) => (
          <button
            class="masonry-item"
            data-index={i}
            aria-label={`Open photo ${i + 1}`}
            type="button"
          >
            <img src={photo.src} alt="" loading="lazy" decoding="async" />
          </button>
        ))}
      </div>
    </div>
  )}

  <!-- Empty state -->
  {!LIGHTROOM_SHARE_URL && allPhotos.length === 0 && (
    <div class="empty-state container">
      <span class="empty-icon">ðŸ“·</span>
      <h2>Gallery coming soon</h2>
      <p>Drop photos into <code>public/images/photography/</code> and they'll appear here automatically on the next build.</p>
    </div>
  )}

  <!-- Lightbox -->
  <dialog class="lightbox" id="lightbox" aria-label="Photo viewer" aria-modal="true">
    <!-- Backdrop: clicking here closes the lightbox -->
    <div class="lb-backdrop" id="lb-backdrop"></div>

    <div class="lb-inner">
      <button class="lb-btn lb-close" id="lb-close" aria-label="Close">âœ•</button>
      <button class="lb-btn lb-prev"  id="lb-prev"  aria-label="Previous">&#8249;</button>
      <button class="lb-btn lb-next"  id="lb-next"  aria-label="Next">&#8250;</button>

      <div class="lb-img-wrap">
        <img id="lb-img" src="" alt="" />
      </div>

      <div class="lb-bar">
        <div class="lb-exif" id="lb-exif"></div>
        <span class="lb-counter" id="lb-counter"></span>
      </div>
    </div>
  </dialog>
</BaseLayout>

<script is:inline define:vars={{ photoData: allPhotos }}>
  const photos = photoData;
  let current = 0;

  const dialog  = document.getElementById('lightbox');
  const lbImg   = document.getElementById('lb-img');
  const counter = document.getElementById('lb-counter');
  const exifEl  = document.getElementById('lb-exif');

  function fmtExposure(t) {
    if (t == null) return null;
    return t >= 1 ? t + '\u2033' : '1\u2044' + Math.round(1 / t);
  }

  function fmtAperture(f) {
    if (f == null) return null;
    return '\u0192/' + (Number.isInteger(f) ? f : f.toFixed(1));
  }

  function buildExifRows(meta) {
    if (!meta) return { gear: [], settings: [], date: null };
    var gear = [];
    var make  = (meta.Make  || '').trim();
    var model = (meta.Model || '').trim();
    if (model) gear.push(model.startsWith(make) ? model : (make + ' ' + model).trim());
    if (meta.LensModel) gear.push(meta.LensModel);

    var settings = [];
    if (meta.FocalLength) settings.push(Math.round(meta.FocalLength) + 'mm');
    var ap = fmtAperture(meta.FNumber);
    if (ap) settings.push(ap);
    var sh = fmtExposure(meta.ExposureTime);
    if (sh) settings.push(sh);
    if (meta.ISO) settings.push('ISO\u00A0' + meta.ISO);

    var date = null;
    if (meta.DateTimeOriginal) {
      var d = new Date(meta.DateTimeOriginal);
      if (!isNaN(d.getTime()))
        date = d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    return { gear: gear, settings: settings, date: date };
  }

  function show(index) {
    current = ((index % photos.length) + photos.length) % photos.length;
    var p = photos[current];
    lbImg.src = p.src;
    counter.textContent = (current + 1) + ' / ' + photos.length;
    var rows = buildExifRows(p.meta);
    var html = '';
    if (rows.gear.length) {
      html += '<div class="exif-gear">' +
        rows.gear.map(function(t) { return '<span class="exif-chip">' + t + '</span>'; }).join('') +
        '</div>';
    }
    if (rows.settings.length || rows.date) {
      html += '<div class="exif-settings">';
      html += rows.settings.map(function(t) { return '<span class="exif-pill">' + t + '</span>'; }).join('');
      if (rows.date) html += '<span class="exif-date">' + rows.date + '</span>';
      html += '</div>';
    }
    exifEl.innerHTML = html;
  }

  function openAt(index) {
    show(index);
    dialog.showModal();
  }

  // Open on thumbnail click
  document.querySelectorAll('.masonry-item').forEach(btn => {
    btn.addEventListener('click', () => openAt(Number(btn.dataset.index)));
  });

  // Controls
  document.getElementById('lb-close').addEventListener('click',   () => dialog.close());
  document.getElementById('lb-prev').addEventListener('click',    () => show(current - 1));
  document.getElementById('lb-next').addEventListener('click',    () => show(current + 1));
  document.getElementById('lb-backdrop').addEventListener('click', () => dialog.close());

  // Keyboard navigation
  document.addEventListener('keydown', e => {
    if (!dialog.open) return;
    if (e.key === 'ArrowLeft')  { e.preventDefault(); show(current - 1); }
    if (e.key === 'ArrowRight') { e.preventDefault(); show(current + 1); }
  });

  // Swipe support
  let touchStartX = 0;
  dialog.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
  dialog.addEventListener('touchend',   e => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    if (Math.abs(dx) > 50) show(dx < 0 ? current + 1 : current - 1);
  });

  // Open directly to a photo when arriving via #open=<encoded-src> (e.g. from homepage strip)
  (function () {
    var hash = window.location.hash;
    if (hash.indexOf('#open=') !== 0) return;
    var targetSrc = decodeURIComponent(hash.slice(6));
    for (var i = 0; i < photos.length; i++) {
      if (photos[i].src === targetSrc) {
        openAt(i);
        // Clean the hash so Back doesn't re-open the lightbox
        history.replaceState(null, '', window.location.pathname);
        break;
      }
    }
  })();
</script>

<style>
  /* â”€â”€ Page header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page-top {
    padding-top: calc(var(--nav-h) + 3rem);
    padding-bottom: 2rem;
  }

  .page-top h1 { margin-bottom: 0.35rem; }
  .page-top p  { font-size: 1.05rem; }

  .lr-link {
    display: inline-block;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--accent);
    text-decoration: none;
  }
  .lr-link:hover { color: var(--accent-hover); }

  /* â”€â”€ Masonry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gallery-wrap { padding-top: 1.5rem; padding-bottom: var(--section-gap); }

  .masonry {
    columns: 2;
    column-gap: 6px;
  }
  @media (min-width: 560px)  { .masonry { columns: 3; } }
  @media (min-width: 900px)  { .masonry { columns: 4; } }

  .masonry-item {
    display: block;
    width: 100%;
    break-inside: avoid;
    margin-bottom: 6px;
    padding: 0;
    border: none;
    background: none;
    cursor: zoom-in;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
  }

  .masonry-item img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 4px;
    background: var(--bg-elevated);
    transition: transform 0.35s ease, opacity 0.2s;
  }

  .masonry-item:hover img {
    transform: scale(1.03);
    opacity: 0.9;
  }

  /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .empty-state {
    padding: var(--section-gap) 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 480px;
  }
  .empty-icon { font-size: 2.5rem; max-width: none; }
  .empty-state h2 { font-size: 1.5rem; }
  .empty-state p  { font-size: 0.9rem; color: var(--text-2); line-height: 1.7; }

  /* â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  dialog.lightbox {
    position: fixed;
    inset: 0;
    margin: 0;
    padding: 0;
    width: 100%;
    max-width: 100%;
    height: 100%;
    max-height: 100%;
    border: none;
    background: rgba(6, 6, 6, 0.97);
    display: none;
    outline: none;
  }

  dialog.lightbox[open] {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  dialog.lightbox::backdrop { display: none; }

  /* Invisible layer that covers the dialog â€” clicking it closes the lightbox */
  .lb-backdrop {
    position: absolute;
    inset: 0;
    z-index: 0;
    cursor: zoom-out;
  }

  .lb-inner {
    position: relative;
    z-index: 1;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    /* top: room for close btn; sides: room for nav btns */
    padding: 3.5rem 5rem 2rem;
    gap: 0.75rem;
    pointer-events: none;
  }

  @media (max-width: 600px) {
    .lb-inner { padding: 3rem 1rem 1.5rem; gap: 0.5rem; }
  }

  /* Buttons â€” these must be interactive */
  .lb-btn {
    position: absolute;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    color: rgba(240,237,232,0.7);
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.15s, color 0.15s;
    line-height: 1;
    pointer-events: auto;
  }

  .lb-btn:hover {
    background: rgba(255,255,255,0.12);
    color: #f0ede8;
  }

  .lb-close {
    top: 1rem;
    right: 1rem;
    font-size: 1rem;
    padding: 0.5rem 0.65rem;
  }

  .lb-prev, .lb-next {
    top: 50%;
    transform: translateY(-50%);
    font-size: 2rem;
    padding: 0.6rem 0.85rem;
  }

  .lb-prev { left: 0.75rem; }
  .lb-next { right: 0.75rem; }

  @media (max-width: 480px) {
    .lb-prev { left: 0.25rem; }
    .lb-next { right: 0.25rem; }
    .lb-prev, .lb-next { font-size: 1.5rem; padding: 0.5rem 0.65rem; }
  }

  /* Image â€” sizes to content, never overflows, only the image itself is interactive */
  .lb-img-wrap {
    flex: 0 1 auto;
    min-height: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    /* NOT pointer-events: auto â€” clicks on empty space fall through to backdrop */
  }

  #lb-img {
    max-width: 100%;
    max-height: calc(100dvh - 11rem);
    object-fit: contain;
    border-radius: 3px;
    display: block;
    user-select: none;
    -webkit-user-drag: none;
    pointer-events: auto;
  }

  /* Bottom bar â€” EXIF then counter */
  .lb-bar {
    flex-shrink: 0;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    pointer-events: auto;
  }

  .lb-exif {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.45rem;
    width: 100%;
  }

  .lb-counter {
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(240,237,232,0.35);
  }

  /* EXIF rows â€” :global() so JS-created elements get these styles */
  :global(.exif-gear) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    justify-content: center;
  }

  :global(.exif-settings) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    justify-content: center;
    align-items: center;
  }

  :global(.exif-chip) {
    font-size: 0.8rem;
    font-weight: 500;
    color: rgba(240,237,232,0.85);
    white-space: nowrap;
    font-family: var(--font-sans);
  }

  :global(.exif-pill) {
    font-size: 0.72rem;
    font-weight: 500;
    padding: 0.18em 0.6em;
    background: rgba(255,255,255,0.09);
    border: 1px solid rgba(255,255,255,0.13);
    border-radius: 4px;
    color: rgba(240,237,232,0.7);
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
    font-family: var(--font-sans);
  }

  :global(.exif-date) {
    font-size: 0.72rem;
    color: rgba(240,237,232,0.4);
    white-space: nowrap;
    font-family: var(--font-sans);
    margin-left: 0.25rem;
  }
</style>
